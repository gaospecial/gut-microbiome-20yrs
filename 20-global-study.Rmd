# (PART) 国际研究格局 {-}

# 国家产出和国际合作 {#global}


## 国际排名的变化

### 如何计算国家间的产出？

一篇文章经常会出现由来自于多个国家的研究人员共同完成的情况。我们认定，当一篇论文的所有作者都来自于同一个国家（地区）时，对应国家的贡献记为 1；当一篇论文的作者来自于多个国家时（N），每个国家对应的贡献记为 1/N。


```{r}
# 计算各国加权发文量
listCO <- strsplit(M$AU_CO_NR,";")
listCO <- lapply(listCO,trim)
nCO <- unlist(lapply(listCO,length))
fracCO <- unlist(lapply(nCO, function(x){rep(1/x,x)}))

if (length(M$PY) != length(nCO)) warning("length(PY) is not equal to length(nCO).")
PY <- unlist(lapply(seq_along(nCO),function(x){rep(M$PY[[x]],nCO[[x]])} ))


country_output <- data.frame(CO=unlist(listCO),
                             PY=PY,
                             Frac=fracCO) %>%
  group_by(CO,PY) %>%
  summarise(contribution=sum(Frac))
```




```{r}
topN <- 10

list <- lapply(unique(country_output$PY),function(y){
  country_output %>% filter(PY==y, CO!="NA") %>%
    arrange(desc(contribution)) %>%
    head(topN) %>% 
    ungroup() %>%
    mutate(rank=row_number())
})

top_country_output <- do.call("rbind",list)
top_country_output$rank <- factor(top_country_output$rank,levels = 20:1)
top_country_output <- top_country_output %>%
  left_join(country_multi_lang,by=c("CO"= "countries")) %>%
  mutate(chinese_abbr=str_sub(China,end = 1))
```


如果我们按照论文发表量对各国“肠道菌群”研究进行排序，可以发现美国一直是排在第一位的，而第二名至第十名则一直在变动。在2000年，美、日、英、法、德是发文量最多的五个国家，到了2010年，前五名是美、法、日、德、英五个国家。值得一提的是，自2010年开始，中国的“肠道菌群”研究以锐不可当的势头，用了三年的时间直接从第十名升到第二名，并一直保持至今（图 \@ref(fig:top-country-ranking)）。

```{r top-country-ranking, fig.cap="各国加权发文量排行榜"}
p <- ggplot(top_country_output,aes(PY,rank,text=paste0(PY,",",China),color=CO,group=CO)) + 
  geom_point(size=6) +  geom_line(size=5,alpha=1/3) +
  geom_text(aes(label=chinese_abbr), hjust=0.5, vjust=0.5,size=3,color="grey",check_overlap = T) +
  labs(x="",y="",title = "各国加权发文量排行榜") +
  scale_color_manual(values = rainbow(20)) +
  theme(plot.title = element_text(hjust = 0,size=16),
        plot.subtitle = element_text(hjust=0,color = "grey20",size=14),
        legend.position = "none") 

plot.ly(p)
```


```{r top-country-output-gif, fig.cap="各国加权发文量"}
p <- ggplot(top_country_output,aes(rank,contribution,fill=CO)) + 
  geom_col() + 
  geom_text(aes(label=CO),position = position_stack(vjust = 1), hjust=0) +
  transition_time(PY) + 
  labs(x="",y="",title = "各国加权发文量",subtitle="年份：{round(frame_time)}") +
  theme(axis.text.y = element_blank(),
        plot.title = element_text(hjust = 0,size=16),
        plot.subtitle = element_text(hjust=0,color = "grey20",size=14)) +
  coord_flip()
animate(p,fps = 10,start_pause=20,end_pause = 20)
```


## 全球合作网络


国际化在“肠道菌群”研究论文中很常见（图 \@ref(fig:MCP-SCP)）。在最主要的`r topN` 个国家中，美国的研究有近 20% 是与其它国家合作完成的，中国发表的论文中也有约 20% 的文章是与其它国家合作完成的；英、法、德、意、加等国的合作研究比例在 30% 附近或者更高。比较例外的是日本，仅有 13% 的研究与其它国家合作完成。


```{r MCP-SCP, fig.cap="各国单独（蓝色）和合作发表（红色）论文的比例"}
mostProdCountries <- result_summary$MostProdCountries %>%
  select(Country,SCP,MCP) %>%
  head(topN) %>%
  mutate_all(trim) %>%
  pivot_longer(cols = -Country) %>%
  mutate(value=as.numeric(value),
         Country=as_factor(as.character(Country))) %>%
  group_by(Country) %>%
  mutate(proportion=value/sum(value))
mostProdCountries$Country <- factor(mostProdCountries$Country, levels=rev(levels(mostProdCountries$Country)))

p <- ggplot(mostProdCountries,aes(Country,value,fill=name,text=paste0(value,"(",format(proportion*100,1),"%)"))) + 
  geom_col() +
  coord_flip() +
  labs(title = "单独和合作发表论文的比例",x="",y="") +
  scale_fill_discrete(name="",breaks=c("SCP","MCP"),labels=c("单独发表","合作发表")) +
  theme(legend.position = c(0.5,0.3), legend.direction = "horizontal")

plot.ly(p) %>%
  layout(
    legend = list(x=0.5,y=0.3,orientation="v")
  )
  
```



我们采用网络分析的方法阐释国际合作。

```{r}
WA <- cocMatrix(data.frame(M), Field = "AU_CO_NR")  # 共现矩阵
netMatrix <- Matrix::crossprod(WA,WA)
netMatrix <- netMatrix[colnames(netMatrix)!= "NA", colnames(netMatrix)!= "NA"]
net <- networkPlot(NetMatrix = netMatrix,
                   n=50,                      # 节点的数目
                   Title = "国家间的合作",
                   type = "auto",           # 图的布局
                   cluster = "spinglass" ,      # 聚类的方法，c("none", optimal", "louvain","infomap","edge_betweenness","walktrap", "spinglass", "leading_eigen", "fast_greedy"
                   size = T,                  # 
                   label.color = TRUE,        # 节点是否按群体着色
                   halo = F,                  # 相同群体会使用同一种颜色
                   weighted = T,
                   remove.multiple = T,
                   remove.isolates = F,
                   verbose = F                # 不画图
                   )
```


```{r country-collaboration-network, fig.cap="国家间的合作网络"}
data <- toVisNetworkData(net$graph)
data$nodes %<>% mutate(id=str_to_title(id))
data$edges %<>% mutate_at(c("from","to"),str_to_title)
visNetwork(nodes=data$nodes, edges = data$edges,width = 800) %>%
  visIgraphLayout() %>%
  visNodes(size = "size",color = "red",group = "community") %>%
  visOptions(
    selectedBy = "id",
    highlightNearest = list(enabled=TRUE,degree=1)
  )

```

## 大国的合作网络

```{r eval=F}
library(networkD3)
sankeyNetwork(filter(data$edges,from=="Usa"),Nodes = data$nodes,Source = "from",Target = "to",Value = "weight",NodeID = "id")
```






## 世界各地的研究机构

```{r}
get_longest <- function(x){
  nc <- nchar(x)
  if (all(is.na(nc))) return(NA)
  i <- which(nc==max(nc))
  if (length(i)>1) i <- i[1]
  return(x[[i]])
}
```



```{r}
# 研究机构排名
affiliations <- tableTag(M,Tag = "AU_UN_NR")

# 机构地址，选最长的那个地址
C2 <- gsub(pattern = "\\[.*?\\]",replacement = "", M$C1)
C2List <- trim(unlist(strsplit(C2,";",fixed = TRUE)))
data <- data.frame(aff=gsub(",.*","",C2List),
                   address=gsub("^[^,]*?,","",C2List))

aff_addr <- data %>% 
  as_tibble() %>% 
  filter(!is.na(aff),!is.na(address)) %>%
  mutate(str_replace_all(aff,"&","AND")) %>% 
  group_by(aff) %>% 
  summarise(addr=get_longest(address))

# 
df <- as_tibble(affiliations) %>%
  filter(Tab!="NA") %>%
  head(1000) %>%
  left_join(aff_addr,by=c("Tab"="aff")) %>%
  mutate(id=row_number())
openxlsx::write.xlsx(df,file = "data-raw/affiliation/Affilliations.xlsx")
```



先谈谈国际合作，再介绍美中两国和其它国家的研究进展。



